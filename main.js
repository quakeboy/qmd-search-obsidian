var w=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var Q=(h,n)=>{for(var t in n)w(h,t,{get:n[t],enumerable:!0})},O=(h,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of A(n))!N.call(h,s)&&s!==t&&w(h,s,{get:()=>n[s],enumerable:!(e=F(n,s))||e.enumerable});return h};var $=h=>O(w({},"__esModule",{value:!0}),h);var R={};Q(R,{default:()=>v});module.exports=$(R);var l=require("obsidian"),L=require("child_process"),k=require("os"),I={qmdPath:"qmd",collection:"obsidian",resultCount:16,extraPath:"",debugLogging:!1},v=class extends l.Plugin{constructor(){super(...arguments);this.settings=I}async onload(){await this.loadSettings(),this.addCommand({id:"qmd-search",name:"Keyword search (fast)",callback:()=>{new m(this.app,this,"search").open()}}),this.addCommand({id:"qmd-vsearch",name:"Semantic search",callback:()=>{new m(this.app,this,"vsearch").open()}}),this.addCommand({id:"qmd-query",name:"Hybrid search (best quality)",callback:()=>{new m(this.app,this,"query").open()}}),this.addSettingTab(new q(this.app,this))}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},b=class b extends l.Modal{constructor(t,e,s){super(t);this.results=[];this.selectedIndex=-1;this.abortController=null;this.plugin=e,this.mode=s}onOpen(){let{contentEl:t,modalEl:e}=this;e.addClass("qmd-search-modal");let s=t.createDiv({cls:"qmd-input-container"});this.inputEl=s.createEl("input",{type:"text",placeholder:`${b.MODE_LABELS[this.mode]||this.mode}...`,cls:"qmd-search-input"}),this.statusEl=t.createDiv({cls:"qmd-status"}),this.statusEl.addClass("qmd-status-hidden"),this.statusEl.removeClass("qmd-status-visible"),this.resultsEl=t.createDiv({cls:"qmd-results"}),this.inputEl.addEventListener("focus",()=>{this.selectedIndex=-1,this.highlightSelected()}),this.inputEl.addEventListener("input",()=>{this.selectedIndex=-1,this.highlightSelected()}),this.inputEl.addEventListener("keydown",i=>{i.key==="Enter"&&!i.isComposing?this.selectedIndex>=0&&this.results.length>0?this.openResult(this.results[this.selectedIndex]):(i.preventDefault(),this.runSearch(this.inputEl.value.trim())):i.key==="ArrowDown"?(i.preventDefault(),this.moveSelection(1)):i.key==="ArrowUp"?(i.preventDefault(),this.moveSelection(-1)):i.key==="Escape"&&this.selectedIndex>=0&&(i.preventDefault(),i.stopPropagation(),this.selectedIndex=-1,this.highlightSelected())}),this.inputEl.focus()}onClose(){var t;(t=this.abortController)==null||t.abort(),this.contentEl.empty()}runSearch(t){var E;if(!t)return;(E=this.abortController)==null||E.abort(),this.abortController=new AbortController,this.results=[],this.selectedIndex=-1,this.resultsEl.empty(),this.showStatus("searching");let{qmdPath:e,collection:s,resultCount:i}=this.plugin.settings,r=(0,k.homedir)(),a=[];this.plugin.settings.extraPath.trim()&&a.push(this.plugin.settings.extraPath.trim()),a.push(`${r}/.bun/bin`,`${r}/.local/bin`,"/usr/local/bin","/opt/homebrew/bin");let u={...process.env,HOME:r,PATH:`${a.join(":")}:${process.env.PATH||""}`},f=[this.mode,t,"--json","-c",s,"-n",String(i)],d=(0,L.spawn)(e,f,{env:u}),S=[],g=[];d.stdout.on("data",o=>{S.push(o)}),d.stderr.on("data",o=>{g.push(o)}),d.on("error",o=>{var c;(c=this.abortController)!=null&&c.signal.aborted||(this.plugin.settings.debugLogging&&console.error("[QMD Search] spawn error:",o),this.showStatus("error",o.message))}),d.on("close",o=>{var C;if((C=this.abortController)!=null&&C.signal.aborted)return;let c=Buffer.concat(S).toString("utf-8"),x=Buffer.concat(g).toString("utf-8");if(this.plugin.settings.debugLogging&&console.debug("[QMD Search] stdout length:",c.length,"stderr length:",x.length),o!==0&&o!==null){let p=x.trim()||`QMD exited with code ${o}`;this.plugin.settings.debugLogging&&console.error("[QMD Search] exit code:",o,"stderr:",x),this.showStatus("error",p);return}try{let p=c.indexOf("["),D=c.lastIndexOf("]");if(p===-1||D===-1){this.plugin.settings.debugLogging&&console.error("[QMD Search] No JSON array found. stdout:",c.slice(0,500)),this.showStatus("empty");return}let T=c.slice(p,D+1),M=this.sanitizeJson(T),P=JSON.parse(M),y=Array.isArray(P)?P:[];this.results=y,y.length===0?this.showStatus("empty"):(this.statusEl.addClass("qmd-status-hidden"),this.statusEl.removeClass("qmd-status-visible"),this.renderResults(y))}catch(p){this.plugin.settings.debugLogging&&(console.error("[QMD Search] JSON parse error:",p),console.error("[QMD Search] stdout length:",c.length)),this.showStatus("error","Failed to parse QMD output."+(this.plugin.settings.debugLogging?" Check console for details.":" Enable debug logging in settings for details."))}}),this.abortController.signal.addEventListener("abort",()=>{d.kill()})}showStatus(t,e){this.statusEl.empty(),this.statusEl.addClass("qmd-status-visible"),this.statusEl.removeClass("qmd-status-hidden"),t==="searching"?(this.statusEl.createDiv({cls:"qmd-spinner"}).addClass("loading"),this.statusEl.createSpan({text:"Searching..."})):t==="empty"?this.statusEl.createSpan({text:"No results found."}):t==="error"&&this.statusEl.createSpan({text:e||"An error occurred.",cls:"qmd-error-text"})}renderResults(t){this.resultsEl.empty();for(let e=0;e<t.length;e++){let s=t[e],i=this.resultsEl.createDiv({cls:"qmd-result-item"}),r=i.createDiv({cls:"qmd-result-header"}),a=s.title||this.fileDisplayName(s.file);r.createDiv({cls:"qmd-result-title"}).setText(a),r.createDiv({cls:"qmd-result-score"}).setText((s.score*100).toFixed(0)+"%");let d=this.cleanFilePath(s.file);i.createDiv({cls:"qmd-result-path"}).setText(d);let g=this.cleanSnippet(s.snippet||s.context||"");g&&i.createDiv({cls:"qmd-result-snippet"}).setText(g.length>200?g.slice(0,200)+"...":g),i.addEventListener("click",()=>this.openResult(s)),i.addEventListener("mouseenter",()=>{this.selectedIndex=e,this.highlightSelected()})}}moveSelection(t){this.results.length!==0&&(this.selectedIndex<0?this.selectedIndex=t>0?0:this.results.length-1:(this.selectedIndex+=t,this.selectedIndex<0&&(this.selectedIndex=this.results.length-1),this.selectedIndex>=this.results.length&&(this.selectedIndex=0)),this.highlightSelected(),this.scrollSelectedIntoView())}highlightSelected(){this.resultsEl.querySelectorAll(".qmd-result-item").forEach((e,s)=>{e.toggleClass("is-selected",s===this.selectedIndex)})}scrollSelectedIntoView(){let t=this.resultsEl.querySelectorAll(".qmd-result-item");this.selectedIndex>=0&&t[this.selectedIndex]&&t[this.selectedIndex].scrollIntoView({block:"nearest"})}openResult(t){let e=this.resolveVaultFile(t.file);if(e)this.app.workspace.openLinkText(e.path,"",!1);else{let i=this.cleanFilePath(t.file).replace(/\.md$/,"");new l.Notice(`Could not resolve file, attempting direct open: ${i}`),this.app.workspace.openLinkText(i,"",!1)}this.close()}resolveVaultFile(t){var a;let e=this.cleanFilePath(t),s=this.normalizeForMatch(((a=e.split("/").pop())==null?void 0:a.replace(/\.md$/,""))||"");if(!s)return null;let i=this.app.vault.getMarkdownFiles();for(let u of i)if(this.normalizeForMatch(u.basename)===s)return{path:u.path};let r=this.normalizeForMatch(e.replace(/\.md$/,""));for(let u of i)if(this.normalizeForMatch(u.path.replace(/\.md$/,""))===r)return{path:u.path};return null}normalizeForMatch(t){return t.toLowerCase().replace(/\s+/g,"-")}cleanFilePath(t){let e=`qmd://${this.plugin.settings.collection}/`;if(t.startsWith(e))return t.slice(e.length);let s=this.plugin.settings.collection+"/";return t.startsWith(s)?t.slice(s.length):t}fileDisplayName(t){let e=this.cleanFilePath(t),s=e.split("/");return(s[s.length-1]||e).replace(/\.md$/,"")}cleanSnippet(t){return t.replace(/@@[^@]*@@\s*\([^)]*\)\s*/g,"").replace(/\n+/g," ").trim()}sanitizeJson(t){let e=[],s=!1,i=0;for(;i<t.length;){let r=t[i];if(s)if(r==="\\")e.push(r),i++,i<t.length&&e.push(t[i]);else if(r==='"')e.push(r),s=!1;else{let a=r.charCodeAt(0);if(a<32)switch(r){case`
`:e.push("\\n");break;case"\r":e.push("\\r");break;case"	":e.push("\\t");break;default:e.push("\\u"+a.toString(16).padStart(4,"0"))}else e.push(r)}else r==='"'&&(s=!0),e.push(r);i++}return e.join("")}shellQuote(t){return"'"+t.replace(/'/g,"'\\''")+"'"}};b.MODE_LABELS={search:"Keyword search",vsearch:"Semantic search",query:"Hybrid search"};var m=b,q=class extends l.PluginSettingTab{constructor(n,t){super(n,t),this.plugin=t}display(){let{containerEl:n}=this;n.empty(),new l.Setting(n).setName("Binary path").setDesc("Full path to the qmd binary. If qmd is in your PATH, just 'qmd' works. Otherwise use the full path, e.g. /Users/you/.bun/bin/qmd").addText(t=>t.setValue(this.plugin.settings.qmdPath).onChange(async e=>{this.plugin.settings.qmdPath=e.trim()||"qmd",await this.plugin.saveSettings()})),new l.Setting(n).setName("Collection name").setDesc("The collection name pointing to your vault. Default value is 'obsidian'").addText(t=>t.setValue(this.plugin.settings.collection).onChange(async e=>{this.plugin.settings.collection=e.trim()||"obsidian",await this.plugin.saveSettings()})),new l.Setting(n).setName("Additional directory to search for bun binary").setDesc("Directory containing the bun binary. QMD needs bun at runtime. Run 'which bun' in your terminal and paste the directory part here. Example: /Users/you/.nvm/versions/node/v22.13.1/bin").addText(t=>t.setPlaceholder("/path/to/directory/containing/bun").setValue(this.plugin.settings.extraPath).onChange(async e=>{this.plugin.settings.extraPath=e,await this.plugin.saveSettings()})),new l.Setting(n).setName("Max results").setDesc("Number of results to return per search. Increasing beyond 16 may cause errors with longer results due to a known output buffering limitation.").addText(t=>t.setPlaceholder("16").setValue(String(this.plugin.settings.resultCount)).onChange(async e=>{let s=parseInt(e,10);this.plugin.settings.resultCount=isNaN(s)||s<1?16:s,await this.plugin.saveSettings()})),new l.Setting(n).setName("Debug logging").setDesc("Log QMD output to the Obsidian developer console (Cmd+Option+I) when errors occur.").addToggle(t=>t.setValue(this.plugin.settings.debugLogging).onChange(async e=>{this.plugin.settings.debugLogging=e,await this.plugin.saveSettings()}))}};
